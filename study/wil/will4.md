# WIL: 동시성을 잡기위한 Lock, Lock - Free

기간 : 2025/11/16 \~ 2025/11/22

### 서론: 이 글을 쓰게 된 이유 <a href="#undefined" id="undefined"></a>

이번 주에는 트랜잭션, 락, 동시성 제어를 다시 공부하면서 예전에 겪었던 데드락 이슈까지 함께 돌아보게 되었습니다. 예전에는 “동시성이면 일단 비관적 락”이라는 생각으로, 꽤 큰 비용을 감수하면서도 락을 거는 쪽을 선택했었습니다. 그때는 맞는 선택이라고 믿었지만, 지금 시점에서 다시 보면 여전히 같은 선택을 할지 스스로에게 질문합니다.

### 과거의 선택: 비관적 락으로 밀어붙이던 시절 <a href="#undefined" id="undefined"></a>

예전에 운영 중인 서비스에서 월 800건 정도의 데드락이 발생하는 API가 있었습니다. 와탭으로 로그를 까보면서 트랜잭션 격리 수준, 데드락이 난 쿼리, 호출 패턴까지 하나씩 따라가며 분석했고, 그 과정에서 삽질도 많이 했습니다. 결국 내린 결론은 “동일한 요청이 동시에 들어오니, 아예 비관적 락으로 순차 처리하자”였다. 그 이후 데드락은 월 5건 정도로 줄었고, 당시엔 꽤 만족스러운 결과였습니다.

지금 다시 보면 이 선택은 “동일 요청을 모두 소중히 처리한다”는 전제를 깔고 있었습니다. 같은 클라이언트가 거의 동시에 이력 저장을 두 번 요청해도, 둘 다 처리하려고 했기 때문에 락 비용을 기꺼이 지불한 셈이었습니다.

### 지금의 시각: 정말 그 정도 값어치가 있었나? <a href="#undefined" id="undefined"></a>

시간이 좀 지나고 나서 와탭 로그와 데드락 분석 일지를 다시 보면, 상황이 단순했습니다.

* 같은 사용자가, 같은 API에, ms 단위 차이로 중복 요청을 보냄
* 앞선 요청은 이미 정상 처리됨
* 뒤이어 온 요청이 락 경합과 데드락의 원인이 됨

이제는 이렇게 생각하게 됩니다.

* 이력이 중복으로 저장되는 게 진짜 그렇게 치명적인가?
* 동일한 페이로드에 대해 두 번 다 성공시켜야 할까, 아니면 한 번만 성공해도 충분한가?
* “정말 동시에 1000명이 이 API를 두드리는가?”라는 질문에, 정직하게 “아니다”라고 답할 수 있다면?

낙관적 락이라는 건, 결국 “충돌은 드물 거다. 설마 이렇게까지 많이 들어오겠어?”를 가정하고, 정말 동시에 들어왔을 때만 버전으로 걸러내자는 방식입니다. 같은 요청이 여러 개 동시에 들어오면, 최초 하나만 성공시키고 나머지는 실패시키거나 버리는 쪽에 가깝습니다. 반면 그때 내가 썼던 비관적 락은 “동일 요청이 오면 다 받아주되, 순서를 보장하면서 천천히 처리하자”에 가까웠고, 그만큼 락 비용도 같이 떠안았습니다.

지금 생각해 보면, 그 API는 “모든 중복 요청을 순차 처리할 만큼” 값어치 있는 작업은 아니었습니다. 동일 이력에 대해서는 한 번만 저장되고, 나머지는 자연스럽게 버려져도 괜찮은 종류의 기능이었을거라 생각하빈다. 굳이 트랜잭션 락을 강하게 거는 대신, 낙관적 락으로 최초 커밋만 인정하고 이후 요청은 유실되어도 된다고 보는 편이, 더 합리적인 설계에 가깝다고 \
지금와서 생각합니다.

### 그래서 지금 왜 다시 락을 공부하고 있을까 <a href="#undefined" id="undefined"></a>

이번에 트랜잭션, 락, 락-프리 기법들을 공뷰하고 내린 결론은 단순했습니다..\
“요구사항을 만족시키기 위해 어떤 기법을 쓸지 선택할 때, 그 비용이 정말 타당한지 설명할 수 있는가?”

* 충돌 빈도가 얼마나 되는지
* 충돌했을 때 비즈니스적으로 얼마나 치명적인지
* 그 문제를 해결하기 위해 락, CAS, 원자적 쿼리 같은 기법을 도입할 가치가 있는지

이 질문에 스스로 납득할 만한 답을 낼 수 있어야 한다고 느꼈습니다. 예전에는 “데드락이 싫으니 비관적 락”이라는 식으로 결론을 밀어붙였다면, 지금은 “이 정도 데이터라면 낙관적 락이나 중복 허용 + 멱등 처리로도 충분하지 않은가?”까지 같이 고민하게 됩니다. 물론 나중와서 지금와서 했던것처럼 다른 결론이 나올수있지만, 지금와서도 그 방법에 대해서도 \
납득이 가게 설명은 기본 전제로 끌고 가야합니다.

이번 WIL에서 남기고 싶은 건 거창한 이론이 아니라, 단순한 주장입니다.

> 동시성 제어는 비용과 리스크의 균형 문제이고, 그 선택에 대해 스스로 납득할 만한 이유를 설명할 수 있어야 한다.

